import streamlit as st
from pathlib import Path

st.set_page_config(page_title="ğŸ§ª ê¸°ìˆ  ë¬¸ì„œ | AIoT ìŠ¤ë§ˆíŠ¸ ì¸í”„ë¼ ëŒ€ì‹œë³´ë“œ", layout="wide")
st.title("ğŸ§ª ê¸°ìˆ  ë¬¸ì„œ (í•µì‹¬ ì½”ë“œ Â· íŒŒì´í”„ë¼ì¸ Â· í•µì‹¬ ê¸°ìˆ )")
st.caption("í•µì‹¬ ëª¨ë“ˆ ë™ì‘ ì›ë¦¬, ë°ì´í„° íŒŒì´í”„ë¼ì¸ ìƒì„¸, ì‚¬ìš© ê¸°ìˆ /ì˜ì¡´ì„±/ì„±ëŠ¥ ì „ëµì„ ë¬¸ì„œí™”")

# ---------------------------------------------------------------------
# ìŠ¤íƒ€ì¼
# ---------------------------------------------------------------------
st.markdown(
    """
    <style>
      .small-muted { color:#9ca3af; font-size:0.9rem; }
      .bullet-muted li { color:#d1d5db; }
      .card { padding: 14px; border-radius: 14px; background: #111827; border: 1px solid #1f2937; }
      hr.soft { border: none; height: 1px; background: #1f2937; margin: 16px 0; }
      pre, code { font-size: 0.95rem; }
    </style>
    """,
    unsafe_allow_html=True,
)

# =====================================================================
# 0) í•œ ëˆˆì— ë³´ê¸°
# =====================================================================
with st.container(border=True):
    st.subheader("ğŸ“Œ ê°œìš”")
    st.markdown(
        """
        - ëª©ì : **ì¬ê±´ì¶• í›„ë³´ì§€ì˜ êµí†µÂ·ì‚¬ì—…ì„±**ì„ AIoT+GIS ë°ì´í„°ë¡œ ì •ëŸ‰í™”í•˜ì—¬ **ì˜ì‚¬ê²°ì •**ì„ ë•ëŠ” ëŒ€ì‹œë³´ë“œ.
        - í•µì‹¬: **ë°˜ê²½ ë‚´ ë§í¬ ë§¤ì¹­ â†’ ì‹œê°„ëŒ€ ì†ë„/í˜¼ì¡ ë¶„ì„ â†’ ì‹œë‚˜ë¦¬ì˜¤Â·ë¯¼ê°ë„Â·í™•ë¥ ** â†’ **ë¦¬í¬íŠ¸**.
        - êµ¬ì¡°: **Streamlit ë©€í‹°í˜ì´ì§€**(pages/*) + **ì»´í¬ë„ŒíŠ¸**(components/*) + **ìœ í‹¸**(utils/*) + **ë°ì´í„°**(data/*).
        """
    )

st.markdown("<hr class='soft'/>", unsafe_allow_html=True)

# =====================================================================
# 1) ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜
# =====================================================================
with st.container(border=True):
    st.subheader("ğŸ— ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜")
    colA, colB = st.columns([1.2, 1])
    with colA:
        st.markdown(
            """
            ```text
            [ì‚¬ìš©ì]
               â”‚  (ì‚¬ì´ë“œë°” ì…ë ¥/í”„ë¦¬ì…‹)
               â–¼
            [app/app.py]
               â”‚  - í˜ì´ì§€ ë¼ìš°íŒ…, ì„¸ì…˜ ìƒíƒœ, ë°ì´í„° ê²½ë¡œ
               â–¼
            [components/]
               â”‚  - sidebar_4quadrant_guide: ê¸°ëŠ¥ ìš”ì•½
               â”‚  - sidebar_presets: ë°ëª¨ í”„ë¦¬ì…‹ ì£¼ì…
               â–¼
            [pages/]
               â”‚  - 1~5: FAQ/ê°œë…/ê°€ì´ë“œ/ë¡œì§/ê³µì‹
               â”‚  - 6: ë°œí‘œì •ë¦¬, 7: ê¸°ìˆ ë¬¸ì„œ(ë³¸ í˜ì´ì§€)
               â–¼
            [utils/]
               â”‚  - traffic_preproc: Excelâ†’CSV í‘œì¤€í™”, í—¤ë”íƒì§€
               â”‚  - traffic_plot: ë°˜ê²½ê²€ìƒ‰+ì†ë„ì°¨íŠ¸(Altair/MPL/Plotly)
               â–¼
            [data/]
               â”œ  ì¬ê±´ì¶• í›„ë³´ì§€ CSV
               â”œ  AverageSpeed/TrafficVolume
               â””  ë„ë¡œë§ SHP(lev5.5)
            ```
            """
        )
    with colB:
        st.markdown(
            """
            **íŠ¹ì§•**
            - ë§í¬ID í‘œì¤€í™”(`link_id`)ì™€ ì¢Œí‘œê³„ ë³€í™˜(EPSG:4326/3857)
            - ë°˜ê²½(ë¯¸í„°) ê¸°ë°˜ **ê·¼ì ‘ ë§í¬ ì„œë¸Œì…‹** ì¶”ì¶œ
            - ë Œë”ëŸ¬ ìŠ¤ìœ„ì¹˜: `Altair` ê¸°ë³¸, `Matplotlib/Plotly` ì˜µì…˜
            - **ì„¸ì…˜ ìƒíƒœ**ë¡œ ì„ íƒ/í”„ë¦¬ì…‹ ìœ ì§€, ìºì‹œë¡œ ì¬ì—°ì‚° ìµœì†Œí™”
            """
        )

st.markdown("<hr class='soft'/>", unsafe_allow_html=True)

# =====================================================================
# 2) í•µì‹¬ ì½”ë“œ ì„¤ëª… (ëª¨ë“ˆ ë³„)
# =====================================================================
with st.container(border=True):
    st.subheader("ğŸ§© í•µì‹¬ ì½”ë“œ ì„¤ëª…")

    with st.expander("utils/traffic_preproc.py â€” Excel â†’ Long CSV í‘œì¤€í™”", expanded=True):
        st.markdown(
            """
            - **ë¬¸ì œ**: ë³´ê³ ì„œí˜• Excelì—ì„œ ì‹œê°„ëŒ€ í—¤ë”(ì˜ˆ: `0~1ì‹œ`) ìœ„ì¹˜ê°€ ë‹¤ë¦„.
            - **í•´ê²°**: ìƒë‹¨ 15í–‰ì„ ìŠ¤ìº”í•˜ì—¬ ì‹œê°„ëŒ€ íŒ¨í„´ì„ ë‹¤ìˆ˜ í¬í•¨í•œ í–‰ì„ **í—¤ë” í–‰**ìœ¼ë¡œ ìë™ íƒì§€.
            - **ì¶œë ¥**: `link_id`, `ì‹œê°„ëŒ€`, `í‰ê· ì†ë„(km/h)`, `hour`(ì •ìˆ˜) ì»¬ëŸ¼ì˜ **Long í¬ë§· CSV**.

            ```python
            def _detect_layout(df0, max_scan_rows=15):
                # '0~1ì‹œ' íŒ¨í„´ ë‹¤ìˆ˜ ì¡´ì¬í•˜ëŠ” í–‰ì„ ì‹œê°„í—¤ë”ë¡œ ì°¾ìŒ
                # base_header_row, time_row, time_start_col, data_start_row ë°˜í™˜

            def convert_average_speed_excel_to_csv(xlsx_path, out_csv_path):
                # 1) ë ˆì´ì•„ì›ƒ íƒì§€ â†’ í—¤ë” êµ¬ì„±
                # 2) wideâ†’long melt, 'ì‹œê°„ëŒ€'ì—ì„œ ì‹œì‘ì‹œê° hour ì¶”ì¶œ
                # 3) ë§í¬ ì‹ë³„ì â†’ í‘œì¤€ ì»¬ëŸ¼ëª… 'link_id'

            def ensure_speed_csv(xlsx_path, out_csv_path):
                # CSV ë¯¸ì¡´ì¬ ì‹œ ìë™ ë³€í™˜ ë³´ì¥
            ```
            """
        )

    with st.expander("utils/traffic_plot.py â€” ë°˜ê²½ ê²€ìƒ‰ + ì‹œê°„ëŒ€ ì†ë„ ì°¨íŠ¸", expanded=True):
        st.markdown(
            """
            - **ëª©í‘œ**: ì¤‘ì‹¬ì (lat/lon)ê³¼ ë°˜ê²½(m) ë‚´ì˜ ë„ë¡œ **ë§í¬**ë¥¼ ì°¾ê³ , í•´ë‹¹ ë§í¬ì˜ **ì‹œê°„ëŒ€ í‰ê· ì†ë„**ë¥¼ ì‹œê°í™”.
            - **ë§í¬ ì¶”ì¶œ**: SHPë¥¼ 4326â†’3857ë¡œ ë³€í™˜ í›„ **ê±°ë¦¬ ê³„ì‚°**ìœ¼ë¡œ ë°˜ê²½ í•„í„°ë§.
            - **ID í‘œì¤€í™”**: CSVì˜ `its_link_id`ë„ ìë™ìœ¼ë¡œ `link_id`ë¡œ í†µì¼.
            - **ë Œë”ëŸ¬**: `plot_speed(..., renderer='altair'|'mpl'|'plotly')` ë¡œ í†µí•© API.

            ```python
            def _read_shp_robust(shp_path):
                # pyogrio/fiona + utf-8/cp949/euc-kr ì¡°í•©ì„ ìˆœì°¨ ì‹œë„ â†’ ê²¬ê³ í•œ ë¡œë”

            def get_nearby_speed_data(csv_path, shp_path, center_lon, center_lat, radius_m=1000):
                # 1) SHPë¥¼ 4326â†’3857ë¡œ íˆ¬ì˜, ì¤‘ì‹¬ì ê³¼ ê±°ë¦¬ ê³„ì‚°
                # 2) ë°˜ê²½ ë‚´ k_link_id ì§‘í•© ë§Œë“¤ê¸°
                # 3) CSVì˜ link_idì™€ êµì§‘í•© í•„í„°
                # 4) ìƒìœ„ Nê°œ ë§í¬ë§Œ ì •ë ¬ ë°˜í™˜

            def altair_nearby_speed(df_plot):
                # legend ì„ íƒê¸°ë¡œ ë§í¬ë³„ ì†ë„ ì¶”ì´ë¥¼ ì¸í„°ë™í‹°ë¸Œí•˜ê²Œ í‘œì‹œ
            ```
            """
        )

    with st.expander("app.py â€” ë°ì´í„° ë³‘í•©, í•„í„°, CFI(í˜¼ì¡ë¹ˆë„ê°•ë„) ê³„ì‚°", expanded=False):
        st.markdown(
            """
            - **ì¢Œí‘œ ë§¤ì¹­**: `merge_projects_with_coords(gu)` â€” í›„ë³´ì§€ ì •ë³´ì™€ ì¢Œí‘œ CSVë¥¼ ì¡°ì¸, ê²°ì¸¡ì€ **êµ¬ ì¤‘ì‹¬+ì§€í„°**ë¡œ ë³´ì •.
            - **í…Œì´ë¸” í•„í„°ë§/ì •ë ¬**: ì„¸ëŒ€ìˆ˜Â·ë©´ì Â·í‚¤ì›Œë“œ ë²”ì£¼ í•„í„° ë° ì •ë ¬ ì˜µì…˜.
            - **í˜¼ì¡ë¹ˆë„ê°•ë„(CFI)**
                - `compute_cfi_weighted(speed_df, vol_df, boundary_speed=30)` :
                  ì†ë„â‰¤ê²½ê³„ê°’ì¼ ë•Œì˜ ì°¨ëŸ‰ìˆ˜ë¥¼ ê°€ì¤‘ í‰ê· í•˜ì—¬ CFI% ì‚°ì¶œ.
                - `compute_cfi_soft(speed_df, vol_df, boundary_mode='percentile', boundary_value=40, tau_kmh=6)` :
                  **ì‹œê·¸ëª¨ì´ë“œ** ê¸°ë°˜ í˜¼ì¡í™•ë¥ ë¡œ ë¶€ë“œëŸ½ê²Œ ì¶”ì •(êµí†µëŸ‰ ê°€ì¤‘).
            ```python
            # í•µì‹¬ ì•„ì´ë””ì–´(soft)
            p = percentile(ì†ë„, boundary_value) if percentile else fixed
            p_cong = 1 / (1 + exp((v - p) / tau))
            CFI = weighted_avg(p_cong, ì°¨ëŸ‰ëŒ€ìˆ˜) * 100
            ```
            """
        )

st.markdown("<hr class='soft'/>", unsafe_allow_html=True)

# =====================================================================
# 3) ë°ì´í„° íŒŒì´í”„ë¼ì¸ (ìƒì„¸ ë‹¨ê³„)
# =====================================================================
with st.container(border=True):
    st.subheader("ğŸ”„ ë°ì´í„° íŒŒì´í”„ë¼ì¸ (ìƒì„¸)")
    st.markdown(
        """
        **ì…ë ¥**: ì¬ê±´ì¶• í›„ë³´ì§€ CSV, AverageSpeed Excel/CSV, TrafficVolume Excel, ë„ë¡œë§ SHP

        **ì „ì²˜ë¦¬**
        1. *ìŠ¤í‚¤ë§ˆ í†µì¼*: í›„ë³´ì§€ CSVì—ì„œ ì»¬ëŸ¼ ì´ì§ˆì„± ë³´ì •(ì„¸ëŒ€ìˆ˜/ë©´ì /ìš©ì ë¥ /ì¸µìˆ˜ íŒŒì‹±, %/ë¬¸ì ì œê±°)
        2. *Excel í‘œì¤€í™”*: `ensure_speed_csv` ë¡œ í‰ê· ì†ë„ ë³´ê³ ì„œë¥¼ **Long CSV**ë¡œ ë³€í™˜
        3. *ì¢Œí‘œê³„/ID ì²˜ë¦¬*: SHP â†’ EPSG:3857, CSV `link_id`ë¥¼ ë¬¸ìì—´í™”(0/NaN/"-1" ì œê±°)
        4. *ê·¼ì ‘ ë§í¬ ì¶”ì¶œ*: ì¤‘ì‹¬ì  ê¸°ì¤€ ë°˜ê²½(m) ë‚´ ë§í¬ ìƒìœ„ Nê°œ ì„ íƒ
        5. *ì†ë„Ã—êµí†µëŸ‰ ê²°í•©*: ì‹œê°„ëŒ€ ë‹¨ìœ„ë¡œ merge í›„ CFI ê³„ì‚°(ê°€ì¤‘/soft)

        **ë¶„ì„/ì‹œê°í™”**
        - pydeck ì§€ë„: ë§í¬ë³„ í˜¼ì¡ ìƒ‰ìƒ (ì¼í‰ê·  ë˜ëŠ” ì‹œê°„ëŒ€ë³„)
        - Altair ì°¨íŠ¸: ë§í¬ë³„ ì‹œê°„ëŒ€ ì†ë„ ì¶”ì´(legend ì„ íƒ)
        - 4ì‚¬ë¶„ë©´ KPI: ë§¤ì¶œ/ë¹„ìš©/NPV/Payback + í˜¼ì¡ë„ ê°œì„ ìœ¨

        **ì¶œë ¥**: ëŒ€ì‹œë³´ë“œ UI, CSV/PDF ë¦¬í¬íŠ¸, ë°œí‘œ/ê¸°ìˆ  í˜ì´ì§€
        """
    )

st.markdown("<hr class='soft'/>", unsafe_allow_html=True)

# =====================================================================
# 4) í•µì‹¬ ê¸°ìˆ  ìŠ¤íƒ & ì˜ì¡´ì„±
# =====================================================================
with st.container(border=True):
    st.subheader("ğŸ›  í•µì‹¬ ê¸°ìˆ ")
    c1, c2, c3 = st.columns(3)
    with c1:
        st.markdown(
            """
            **ë°ì´í„°/ìˆ˜ì¹˜**
            - pandas / numpy
            - numpy_financial (NPV)
            - geopandas / shapely
            """
        )
    with c2:
        st.markdown(
            """
            **ì‹œê°í™”**
            - pydeck (ì§€ë„)
            - Altair (ê¸°ë³¸ ì°¨íŠ¸)
            - Matplotlib/Plotly (ì˜µì…˜)
            """
        )
    with c3:
        st.markdown(
            """
            **ì•±/ì—”ì§„**
            - Streamlit ë©€í‹°í˜ì´ì§€
            - ìºì‹œ(`st.cache_data`), ì„¸ì…˜ ìƒíƒœ
            - íŒŒì¼ ì¸ì½”ë”©/ì—”ì§„ í´ë°±(pyogrio/fiona)
            """
        )

with st.container(border=True):
    st.subheader("ğŸ“¦ requirements (ìš”ì•½)")
    st.code(
        """
        streamlit
        pandas
        numpy
        numpy-financial
        altair
        pydeck
        geopandas
        shapely
        fiona
        pyogrio
        """,
        language="text",
    )

st.markdown("<hr class='soft'/>", unsafe_allow_html=True)

# =====================================================================
# 5) ì„±ëŠ¥Â·ì‹ ë¢°ì„± ì „ëµ
# =====================================================================
with st.container(border=True):
    st.subheader("âš¡ ì„±ëŠ¥/ì‹ ë¢°ì„±")
    st.markdown(
        """
        - **ìºì‹œ**: CSV/ì¡°ì¸/ê·¼ì ‘ê²€ìƒ‰ ê²°ê³¼ `st.cache_data` ë¡œ ì¬ì‚¬ìš©.
        - **ê°•ì¸í•œ SHP ë¡œë”©**: pyogrioâ†’fiona, utf-8â†’cp949â†’euc-kr ìˆœì°¨ ì‹œë„.
        - **ìœ íš¨ì„± ì²´í¬**: ìˆ«ì íŒŒì‹±(%, ì‰¼í‘œ, ì¸µìˆ˜ ë“±) ë° 0/ê²°ì¸¡ì¹˜ í•„í„°.
        - **í´ë°± ì„¤ê³„**: Altair ì‹¤íŒ¨ ì‹œ Matplotlib/Plotlyë¡œ ëŒ€ì²´ ê°€ëŠ¥.
        - **ë‹¨ìœ„ ì •í•©ì„± ì£¼ì˜**: ë¶„ì–‘ê°€/ê³µì‚¬ë¹„(ë§Œì›/ã¡) â†” ì–µì› í™˜ì‚° ìŠ¤ì¼€ì¼ ì ê²€.
        """
    )

st.markdown("<hr class='soft'/>", unsafe_allow_html=True)

# =====================================================================
# 6) í–¥í›„ ê³ ë„í™” ë¡œë“œë§µ
# =====================================================================
with st.container(border=True):
    st.subheader("ğŸš€ í–¥í›„ ê³ ë„í™”")
    st.markdown(
        """
        - **ì‹¤ì‹œê°„ AIoT ì—°ë™**: êµí†µì„¼ì„œ/ë²„ìŠ¤í˜¼ì¡ API â†’ ì‹œê°„ë³„ ìë™ ì—…ë°ì´íŠ¸
        - **ê³ ê¸‰ êµí†µëª¨í˜•**: OD ê¸°ë°˜ ì‹œë®¬ë ˆì´ì…˜, ì‹ í˜¸ì£¼ê¸°/ë²„ìŠ¤ì¦í¸ ìµœì í™”
        - **KPI í™•ì¥**: ë¯¼ì›ë¦¬ìŠ¤í¬/ì ‘ê·¼ì„± ì§€ìˆ˜/í™˜ê²½ì˜í–¥ í¬í•¨
        - **ê¶Œí•œ/ë²„ì „ê´€ë¦¬**: ì‚¬ìš©ì ì—­í• ë³„ ë³´ê¸°, ì„¤ì • í…œí”Œë¦¿ ì €ì¥
        - **ë°°í¬**: Docker/CloudRun, ë°ì´í„° ìºì‹œ ë ˆì´ì–´(Parquet/Feather)
        """
    )

st.markdown("<hr class='soft'/>", unsafe_allow_html=True)

# =====================================================================
# 7) ê¸°ìˆ  ë¬¸ì„œ ë‹¤ìš´ë¡œë“œ
# =====================================================================
with st.container(border=True):
    st.subheader("â¬‡ï¸ ê¸°ìˆ  ë¬¸ì„œ(.md) ë‹¤ìš´ë¡œë“œ")
    md = """
# ê¸°ìˆ  ë¬¸ì„œ (ìš”ì•½)

## ì•„í‚¤í…ì²˜
ì‚¬ìš©ì â†’ app.py â†’ components â†’ pages â†’ utils â†’ data

## í•µì‹¬ ì½”ë“œ
- traffic_preproc: Excel ë ˆì´ì•„ì›ƒ ìë™íƒì§€, long CSV í‘œì¤€í™”, link_id í†µì¼
- traffic_plot: SHP ê²¬ê³  ë¡œë”©, ë°˜ê²½ í•„í„°, ì‹œê°„ëŒ€ ì†ë„ ì°¨íŠ¸(Altair/MPL/Plotly)
- app.py: í›„ë³´ì§€ ì¢Œí‘œ ë§¤ì¹­, í…Œì´ë¸” í•„í„°, CFI ê³„ì‚°(ê°€ì¤‘/soft)

## íŒŒì´í”„ë¼ì¸
ì›ì²œë°ì´í„° â†’ ì „ì²˜ë¦¬(ìŠ¤í‚¤ë§ˆ/Excelâ†’CSV/ì¢Œí‘œê³„) â†’ ê·¼ì ‘ê²€ìƒ‰ â†’ ì†ë„Ã—êµí†µëŸ‰ ê²°í•© â†’ CFI/KPI â†’ ì§€ë„+ì°¨íŠ¸ â†’ ë¦¬í¬íŠ¸

## ê¸°ìˆ  ìŠ¤íƒ
Streamlit, pandas/numpy, numpy-financial, geopandas/shapely, altair, pydeck, fiona/pyogrio

## ì„±ëŠ¥/ì‹ ë¢°ì„±
ìºì‹œ, ì¸ì½”ë”© í´ë°±, ë‹¨ìœ„ ì •í•©ì„±, í´ë°± ë Œë”ëŸ¬, ë°ì´í„° ìœ íš¨ì„± ì²´í¬

## í–¥í›„ ê³ ë„í™”
ì‹¤ì‹œê°„ AIoT, ê³ ê¸‰ êµí†µëª¨í˜•, KPI í™•ì¥, ì—­í• ê¶Œí•œ, Docker ë°°í¬
"""
    st.download_button("ê¸°ìˆ  ë¬¸ì„œ(.md) ë‹¤ìš´ë¡œë“œ", data=md, file_name="tech_spec.md", mime="text/markdown")

st.caption("Â© AIoT ìŠ¤ë§ˆíŠ¸ ì¸í”„ë¼ ëŒ€ì‹œë³´ë“œ â€” í•µì‹¬ ê¸°ìˆ  ë¬¸ì„œ")
