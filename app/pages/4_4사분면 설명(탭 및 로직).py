import streamlit as st

def app():
    st.title("🧾 4사분면 시나리오·재무·민감도·리포트 설명")
    st.markdown("---")

    st.markdown("""
    ## 📘 개요
    이 페이지는 **4사분면(시나리오·재무·민감도·리포트)** 탭의 계산 로직과 사용 방법을 정리한 설명서입니다.  
    대시보드는 주택 재개발 사업의 사업성 및 교통영향을 **AIoT 기반으로 시각화·수치화**하기 위해 설계되었습니다.
    """)

    # ------------------------------------------------------------
    st.header("① KPI 계산 로직 (`calc_kpis`)")
    st.markdown("""
    **입력 변수**
    - 세대수(`households`)
    - 평균 전용면적(`avg_py`)
    - 분양가(`sale_price_per_m2`, 만원/㎡)
    - 공사비(`build_cost_per_m2`, 만원/㎡)
    - 인프라 투자(`infra_invest_billion`, 억원)
    - 기준 혼잡도(`congestion_base`, %)
    - 버스 증편률(`bus_inc_pct`, %)
    - 비분양 비율(`non_sale_ratio`, 기본 0.15)
    - 분양률(`sale_rate`, 기본 0.98)
    - 할인율(`disc_rate`, 기본 0.07)
    - 회수기간(`years`, 기본 4년)
    """)

    st.markdown("""
    **1️⃣ 면적 환산**
    ```python
    m2_per_py = 3.3058
    sellable_m2 = households * avg_py * m2_per_py * (1 - non_sale_ratio)
    ```
    → 세대수·평형을 이용해 분양 가능한 면적(㎡) 계산
    """)

    st.markdown("""
    **2️⃣ 혼잡도 개선(간이모델)**  
    버스 증편에 따른 혼잡도 완화 효과를 선형 근사로 표현합니다.
    ```python
    predicted_cong = max(0, congestion_base * (1 - bus_inc_pct / 150))
    cong_improve = congestion_base - predicted_cong
    ```
    - 150% 증편 시 혼잡도는 이론상 0%로 수렴  
    - 즉, 버스 증편 1%p마다 약 0.67%p 혼잡도 완화
    """)

    st.markdown("""
    **3️⃣ 매출·비용 산정**
    ```python
    revenue_won = sellable_m2 * sale_price_per_m2 * sale_rate   # (만원)
    cost_won = sellable_m2 * build_cost_per_m2                   # (만원)

    total_rev_bil  = revenue_won / 1e4 / 100                    # (억원)
    total_cost_bil = cost_won / 1e4 / 100 + infra_invest_billion
    ```
    ⚠️ *단위 주의:* 코드에서는 `만원 → 억원` 환산 시 `/10,000/100`을 적용하므로 실제 환산 스케일은 `/1,000,000`.  
    필요 시 `/10,000`으로 조정하여 인프라투자(억원)과 단위를 일치시켜야 합니다.
    """)

    st.markdown("""
    **4️⃣ 이익·마진율**
    ```python
    profit_bil = total_rev_bil - total_cost_bil
    margin_pct = (profit_bil / total_cost_bil) * 100
    ```
    """)

    st.markdown("""
    **5️⃣ 단순 NPV 및 회수기간**
    ```python
    cf_annual = profit_bil / years
    npv = sum([cf_annual / ((1+disc_rate)**t) for t in range(1, years+1)])
    payback = ceil(total_cost_bil / cf_annual)
    ```
    - 연평균 현금흐름을 균등 가정  
    - 회수기간은 `총사업비 ÷ 연간이익`으로 계산
    """)

    # ------------------------------------------------------------
    st.header("② 시나리오 탭 (🧩 입력·비교)")
    st.markdown("""
    - 공통 입력: 세대수, 평균면적, 혼잡도, 비분양비율, 분양률, 할인율 등  
    - 시나리오 A/B/C: **분양가·공사비·버스증편·인프라투자**만 다르게 설정  
    - 각 시나리오의 KPI를 계산하여 비교표(DataFrame)로 표시  
    - NPV가 가장 높은 시나리오를 ‘추천 시나리오’로 표시
    """)

    # ------------------------------------------------------------
    st.header("③ 민감도 탭 (📈 토네이도 차트)")
    st.markdown("""
    - 기준값: 분양가, 공사비, 버스증편, 인프라투자  
    - ±변동폭(%)을 조정하여 각 변수 변화가 NPV에 미치는 영향 시각화  
    - 가장 긴 막대를 가지는 요인이 **NPV에 민감한 변수**를 의미
    """)

    # ------------------------------------------------------------
    st.header("④ 확률 탭 (🎲 간이 Monte Carlo)")
    st.markdown("""
    - 분양가·공사비를 정규분포로 난수 샘플링  
    - 각 시뮬레이션마다 NPV 계산 → 분포 분석  
    - P10/P50/P90 NPV를 출력해 **리스크·불확실성 범위** 확인 가능
    """)

    # ------------------------------------------------------------
    st.header("⑤ 리포트 탭 (📤 체크리스트·PDF 내보내기)")
    st.markdown("""
    **자동 체크 조건**
    - Δ혼잡도 ≥ 5% → 교통영향평가 근거로 활용  
    - 마진율 < 10% → 공사비·평형믹스 재검토  
    - NPV < 0 → 분양가 조정 또는 인프라 투자 축소 필요  

    **내보내기 기능**
    - 시나리오 비교표 CSV 다운로드  
    - PDF 리포트(ReportLab 기반): 대상지, 시나리오 요약, 행정 협의 포인트, 주요 파라미터 기록
    """)

    # ------------------------------------------------------------
    st.header("⑥ 활용 흐름 요약")
    st.markdown("""
    1️⃣ 대상지 선택  
    2️⃣ 공통 입력 설정  
    3️⃣ 시나리오 A/B/C 입력 및 결과 비교  
    4️⃣ 민감도 분석으로 주요 변수 확인  
    5️⃣ 확률 분석으로 리스크 파악  
    6️⃣ 리포트 탭에서 결과 정리·PDF 저장
    """)

    # ------------------------------------------------------------
    st.header("⑦ 모델 가정 및 주의사항")
    st.markdown("""
    - **혼잡도 모델:** 버스 증편 효과를 단순 선형으로 근사 (비선형 효과 미반영)  
    - **현금흐름 모델:** 균등 분할 가정, 실제 사업은 연도별 CF 패턴 반영 필요  
    - **금액 단위:** 만원→억원 변환식의 스케일 확인 필요  
    - **민감도:** 변수 단위(%)·(%p) 차이 유의  
    - **Monte Carlo:** 분양가·공사비만 확률 변수로 설정됨 (버스·인프라도 확장 가능)
    """)

    st.info("✅ 이 설명서는 ‘4사분면 시나리오·재무·민감도·리포트’ 탭의 공식 계산식과 사용 절차를 이해하기 위한 내부 문서입니다.")

# Streamlit 실행 시 필요
if __name__ == "__main__":
    app()
